        -:    0:Source:/home/neo/MedicamentLibrary/common/db/postgres/pqxx_impl/include/pqxx_client.hpp
        -:    0:Graph:/home/neo/MedicamentLibrary/cmake-build-ninja--vcpkg-dbg-rel-coverage/common/db/postgres/pqxx_impl/CMakeFiles/DrugLib_Common_Database_PqxxClient.dir/source/pqxx_client.cpp.gcno
        -:    0:Data:/home/neo/MedicamentLibrary/cmake-build-ninja--vcpkg-dbg-rel-coverage/common/db/postgres/pqxx_impl/CMakeFiles/DrugLib_Common_Database_PqxxClient.dir/source/pqxx_client.cpp.gcda
        -:    0:Runs:1
        -:    0:Programs:1
        -:    1:// pqxx_client.hpp
        -:    2:#pragma once
        -:    3:
        -:    4:#include <memory>
        -:    5:#include <mutex>
        -:    6:#include <regex>
        -:    7:#include <string>
        -:    8:#include <string_view>
        -:    9:#include <vector>
        -:   10:#include <boost/container/flat_map.hpp>
        -:   11:#include <pqxx/pqxx>
        -:   12:
        -:   13:#include "db_interface.hpp"
        -:   14:#include "exceptions.hpp"
        -:   15:#include "pqxx_connect_params.hpp"
        -:   16:
        -:   17:
        -:   18:namespace drug_lib::common::database
        -:   19:{
        -:   20:    class PqxxClient final : public interfaces::DbInterface
        -:   21:    {
        -:   22:    public:
        -:   23:        /// @brief Creating database with given params using template db
        -:   24:        static void create_database(std::string_view host,
        -:   25:                                    uint32_t port,
        -:   26:                                    std::string_view db_name,
        -:   27:                                    std::string_view login,
        -:   28:                                    std::string_view password);
        -:   29:        static void create_database(const PqxxConnectParams& pr);
        -:   30:        /// @brief Explicitly close the connection. Destructor do the same, but this function can throw exception
        -:   31:        void drop_connect() override;
        -:   32:
        -:   33:
        -:   34:        /// @brief Trying to connect to the database, if connection is not open will throw exception
        -:   35:        /// @throws drug_lib::common::database::exceptions::ConnectionException
        -:   36:        PqxxClient(std::string_view host,
        -:   37:                   uint32_t port,
        -:   38:                   std::string_view db_name,
        -:   39:                   std::string_view login,
        -:   40:                   std::string_view password);
        -:   41:        explicit PqxxClient(const PqxxConnectParams& pr);
function _ZN8drug_lib6common8database10PqxxClientD2Ev called 0 returned 0% blocks executed 0%
function _ZN8drug_lib6common8database10PqxxClientD0Ev called 0 returned 0% blocks executed 0%
    #####:   42:        ~PqxxClient() override = default;
    $$$$$:   42-block  0
    $$$$$:   42-block  1
        -:   43:
        -:   44:        // Transaction Methods
        -:   45:        /// @brief Start a transaction. All queries before commiting/roll backing a transaction will use common transaction
        -:   46:        /// @throws  drug_lib::common::database::exceptions::TransactionException
        -:   47:        void start_transaction() override;
        -:   48:
        -:   49:        /// @brief Commit a transaction. If throws an exception, all transaction will be reverted
        -:   50:        /// @throws  drug_lib::common::database::exceptions::TransactionException
        -:   51:        void commit_transaction() override;
        -:   52:
        -:   53:        /// @brief Instantly cancel a transaction
        -:   54:        /// @throws  drug_lib::common::database::exceptions::TransactionException
        -:   55:        void rollback_transaction() override;
        -:   56:
        -:   57:        /// @brief Create unique index for the table
        -:   58:        /// @param table_name For which table created index.
        -:   59:        /// @param conflict_fields Fields which will be unique for each record
        -:   60:        void make_unique_constraint(std::string_view table_name,
        -:   61:                                    std::vector<std::shared_ptr<FieldBase>> conflict_fields) override;
        -:   62:
        -:   63:        /// @brief Create full test search index for given fields
        -:   64:        /// @param table_name For which table created index.
        -:   65:        /// @param fields Fts fields
        -:   66:        void setup_fts_index(
        -:   67:            std::string_view table_name,
        -:   68:            std::vector<std::shared_ptr<FieldBase>> fields) override;
        -:   69:
        -:   70:        /// @brief Drop index, but doesn't remove fts fields from this client. Allows to restore it(reindex) using restore_full_text_search method
        -:   71:        void drop_fts_index(std::string_view table_name) const override;
        -:   72:
        -:   73:        /// @brief Drop index + remove fields from this client. For using fts further setup_fulltext_search should be called again
        -:   74:        void remove_fts_index(std::string_view table_name) override;
        -:   75:
        -:   76:        /// @brief Restore index + reindex. Use previous declared fts fields
        -:   77:        void restore_fts_index(std::string_view table_name) const override;
        -:   78:        // Table Management
        -:   79:
        -:   80:        /// @param table_name new table name
        -:   81:        /// @param field_list properties of fields of new table
        -:   82:        void create_table(std::string_view table_name, const Record& field_list) override;
        -:   83:
        -:   84:        void remove_table(std::string_view table_name) override;
        -:   85:        void truncate_table(std::string_view table_name) override;
        -:   86:        /// @return Existence status of table
        -:   87:        [[nodiscard]] bool check_table(std::string_view table_name) override;
        -:   88:
        -:   89:        // Data Retrieval
        -:   90:
        -:   91:        /// @brief Select records follow conditions. Copy all data to own it
        -:   92:        /// @return Vector of records. Each element of vector - one row in a table
        -:   93:        [[nodiscard]] std::vector<Record> select(
        -:   94:            std::string_view table_name,
        -:   95:            const Conditions& conditions) const override;
        -:   96:        /// @brief Select all table records.
        -:   97:        /// @warning Slow, because of copying all fields
        -:   98:        [[nodiscard]] std::vector<Record> select(
        -:   99:            std::string_view table_name) const override;
        -:  100:
        -:  101:        /// @brief Faster than select, but doesn't transform and allows only one operation view field
        -:  102:        /// @return Vector of view records. Each element of vector - one row in a table
        -:  103:        /// @warning If u need not only view data, use select.
        -:  104:        [[nodiscard]] std::vector<std::unique_ptr<ViewRecord>> view(
        -:  105:            std::string_view table_name,
        -:  106:            const Conditions& conditions) const override;
        -:  107:
        -:  108:        /// @brief Faster than select, but doesn't transform and allows only one operation view field
        -:  109:        /// @return Vector of view records. Each element of vector - one row in a table
        -:  110:        /// @warning If u need not only view data, use select.
        -:  111:        [[nodiscard]] std::vector<std::unique_ptr<ViewRecord>> view(std::string_view table_name) const override;
        -:  112:        // Remove Data
        -:  113:        ///@brief remove data following conditions
        -:  114:        void remove(std::string_view table_name,
        -:  115:                    const Conditions& conditions) override;
        -:  116:
        -:  117:        // Get Record Count
        -:  118:        /// @return Count of records
        -:  119:        [[nodiscard]] uint32_t count(std::string_view table_name,
        -:  120:                                     const Conditions& conditions) const override;
        -:  121:        /// @return Count of all records in table
        -:  122:        [[nodiscard]] uint32_t count(std::string_view table_name) const override;
        -:  123:
        -:  124:    protected:
        -:  125:        // Implementation Methods for Data Manipulation
        -:  126:        void insert_implementation(std::string_view table_name, const std::vector<Record>& rows) override;
        -:  127:        void insert_implementation(std::string_view table_name, std::vector<Record>&& rows) override;
        -:  128:
        -:  129:        void upsert_implementation(std::string_view table_name,
        -:  130:                                   const std::vector<Record>& rows,
        -:  131:                                   const std::vector<std::shared_ptr<FieldBase>>& replace_fields) override;
        -:  132:
        -:  133:        void upsert_implementation(std::string_view table_name,
        -:  134:                                   std::vector<Record>&& rows,
        -:  135:                                   const std::vector<std::shared_ptr<FieldBase>>& replace_fields) override;
        -:  136:
        -:  137:    private:
        -:  138:        boost::container::flat_map<uint32_t, std::string> type_oids_; // id, name
        -:  139:        boost::container::flat_map<std::string, std::vector<std::shared_ptr<FieldBase>>> conflict_fields_ = {};
        -:  140:        boost::container::flat_map<std::string, std::vector<std::shared_ptr<FieldBase>>> fts_fields_ = {};
        -:  141:        std::shared_ptr<pqxx::connection> conn_;
        -:  142:        mutable std::recursive_mutex conn_mutex_;
        -:  143:        mutable std::unique_ptr<pqxx::work> open_transaction_;
        -:  144:        bool in_transaction_;
        -:  145:
        -:  146:        void _oid_preprocess();
        -:  147:        [[nodiscard]] std::unique_ptr<FieldBase> process_field(const pqxx::field& field) const;
        -:  148:        // Utility Methods
        -:  149:        [[nodiscard]] static bool is_valid_identifier(std::string_view identifier);
        -:  150:
        -:  151:        void execute_query(const std::string& query_string, const pqxx::params& params) const;
        -:  152:        void execute_query(const std::string& query_string) const;
        -:  153:        pqxx::result execute_query_with_result(const std::string& query_string, const pqxx::params& params) const;
        -:  154:        pqxx::result execute_query_with_result(const std::string& query_string) const;
        -:  155:
        -:  156:        template <interfaces::RecordContainer Rec>
function _ZNK8drug_lib6common8database10PqxxClient22construct_insert_queryITkNS1_10interfaces15RecordContainerERKSt6vectorINS1_6RecordESaIS6_EEEESt4pairINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEN4pqxx6paramsEESt17basic_string_viewIcSF_EOT_ called 14 returned 100% blocks executed 57%
function _ZNK8drug_lib6common8database10PqxxClient22construct_insert_queryITkNS1_10interfaces15RecordContainerESt6vectorINS1_6RecordESaIS6_EEEESt4pairINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEN4pqxx6paramsEESt17basic_string_viewIcSD_EOT_ called 100052 returned 93% blocks executed 59%
function _ZNK8drug_lib6common8database10PqxxClient22construct_insert_queryITkNS1_10interfaces15RecordContainerERSt6vectorINS1_6RecordESaIS6_EEEESt4pairINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEN4pqxx6paramsEESt17basic_string_viewIcSE_EOT_ called 0 returned 0% blocks executed 0%
   100066:  157:        std::pair<std::string, pqxx::params> construct_insert_query(
        -:  158:            const std::string_view table_name,
        -:  159:            Rec&& rows) const
        -:  160:        {
   100066:  161:            if (rows.empty())
       14:  161-block  0
branch  0 taken 14
branch  1 taken 0
   100052:  161-block  1
branch  2 taken 100052
branch  3 taken 0
    $$$$$:  161-block  2
branch  4 never executed
branch  5 never executed
        -:  162:            {
    #####:  163:                throw exceptions::QueryException("No data provided for insert.", errors::db_error_code::INVALID_QUERY);
    $$$$$:  163-block  0
branch  0 never executed
branch  1 never executed
    $$$$$:  163-block  1
branch  2 never executed
branch  3 never executed
    $$$$$:  163-block  2
branch  4 never executed
branch  5 never executed
    $$$$$:  163-block  3
    $$$$$:  163-block  4
branch  6 never executed
branch  7 never executed
    $$$$$:  163-block  5
    $$$$$:  163-block  6
    $$$$$:  163-block  7
    $$$$$:  163-block  8
branch  8 never executed
branch  9 never executed
    $$$$$:  163-block  9
branch 10 never executed
branch 11 never executed
    $$$$$:  163-block 10
branch 12 never executed
branch 13 never executed
    $$$$$:  163-block 11
    $$$$$:  163-block 12
branch 14 never executed
branch 15 never executed
    $$$$$:  163-block 13
    $$$$$:  163-block 14
    $$$$$:  163-block 15
    $$$$$:  163-block 16
branch 16 never executed
branch 17 never executed
    $$$$$:  163-block 17
branch 18 never executed
branch 19 never executed
    $$$$$:  163-block 18
branch 20 never executed
branch 21 never executed
    $$$$$:  163-block 19
    $$$$$:  163-block 20
branch 22 never executed
branch 23 never executed
    $$$$$:  163-block 21
    $$$$$:  163-block 22
    $$$$$:  163-block 23
        -:  164:            }
   100066:  165:            const std::string table = escape_identifier(table_name);
   100066:  166:            std::ostringstream query_stream;
       14:  166-block  0
branch  0 taken 14
branch  1 taken 0
   100052:  166-block  1
branch  2 taken 100052
branch  3 taken 0
    $$$$$:  166-block  2
branch  4 never executed
branch  5 never executed
   100066:  167:            query_stream << "INSERT INTO " << table << " (";
       14:  167-block  0
branch  0 taken 14
branch  1 taken 0
       14:  167-block  1
branch  2 taken 14
branch  3 taken 0
       14:  167-block  2
branch  4 taken 14
branch  5 taken 0
   100052:  167-block  3
branch  6 taken 100052
branch  7 taken 0
   100052:  167-block  4
branch  8 taken 100052
branch  9 taken 0
   100052:  167-block  5
branch 10 taken 100052
branch 11 taken 0
    $$$$$:  167-block  6
branch 12 never executed
branch 13 never executed
    $$$$$:  167-block  7
branch 14 never executed
branch 15 never executed
    $$$$$:  167-block  8
branch 16 never executed
branch 17 never executed
        -:  168:            // Get field names from the first record
   100066:  169:            const auto& first_record = rows.front();
   100066:  170:            std::vector<std::string> field_names;
   400263:  171:            for (const auto& it : first_record)
       14:  171-block  0
       55:  171-block  1
branch  0 taken 14
branch  1 taken 41
       41:  171-block  2
       41:  171-block  3
   100052:  171-block  4
   400208:  171-block  5
branch  2 taken 100052
branch  3 taken 300156
   300156:  171-block  6
   300156:  171-block  7
    $$$$$:  171-block  8
    $$$$$:  171-block  9
branch  4 never executed
branch  5 never executed
    $$$$$:  171-block 10
    $$$$$:  171-block 11
        -:  172:            {
   300197:  173:                field_names.push_back(it->get_name());
       41:  173-block  0
branch  0 taken 41
branch  1 taken 0
       41:  173-block  1
branch  2 taken 41
branch  3 taken 0
   300156:  173-block  2
branch  4 taken 300156
branch  5 taken 0
   300156:  173-block  3
branch  6 taken 300156
branch  7 taken 0
    $$$$$:  173-block  4
branch  8 never executed
branch  9 never executed
    $$$$$:  173-block  5
branch 10 never executed
branch 11 never executed
   300197:  174:                query_stream << escape_identifier(field_names.back()) << ", ";
       41:  174-block  0
branch  0 taken 41
branch  1 taken 0
       41:  174-block  1
branch  2 taken 41
branch  3 taken 0
       41:  174-block  2
branch  4 taken 41
branch  5 taken 0
    $$$$$:  174-block  3
   300156:  174-block  4
branch  6 taken 300156
branch  7 taken 0
   300156:  174-block  5
branch  8 taken 300156
branch  9 taken 0
   300156:  174-block  6
branch 10 taken 300156
branch 11 taken 0
    $$$$$:  174-block  7
    $$$$$:  174-block  8
branch 12 never executed
branch 13 never executed
    $$$$$:  174-block  9
branch 14 never executed
branch 15 never executed
    $$$$$:  174-block 10
branch 16 never executed
branch 17 never executed
    $$$$$:  174-block 11
        -:  175:            }
   100066:  176:            std::string query = query_stream.str();
       14:  176-block  0
branch  0 taken 14
branch  1 taken 0
   100052:  176-block  1
branch  2 taken 100052
branch  3 taken 0
    $$$$$:  176-block  2
branch  4 never executed
branch  5 never executed
   100066:  177:            query.erase(query.size() - 2); // Remove last comma and space
       14:  177-block  0
branch  0 taken 14
branch  1 taken 0
   100052:  177-block  1
branch  2 taken 100052
branch  3 taken 0
    $$$$$:  177-block  2
branch  4 never executed
branch  5 never executed
   100066:  178:            query += ") VALUES ";
       14:  178-block  0
branch  0 taken 14
branch  1 taken 0
   100052:  178-block  1
branch  2 taken 100052
branch  3 taken 0
    $$$$$:  178-block  2
branch  4 never executed
branch  5 never executed
        -:  179:
        -:  180:
   100066:  181:            pqxx::params params;
   100066:  182:            uint32_t param_counter = 1;
   978599:  183:            for (auto&& record : std::forward<Rec>(rows))
       14:  183-block  0
      545:  183-block  1
branch  0 taken 14
branch  1 taken 531
      531:  183-block  2
      531:  183-block  3
   100052:  183-block  4
   978054:  183-block  5
branch  2 taken 100052
branch  3 taken 878002
   878002:  183-block  6
   878002:  183-block  7
    $$$$$:  183-block  8
    $$$$$:  183-block  9
branch  4 never executed
branch  5 never executed
    $$$$$:  183-block 10
    $$$$$:  183-block 11
        -:  184:            {
   878533:  185:                query += "(";
      531:  185-block  0
branch  0 taken 531
branch  1 taken 0
   879446:  185-block  1
branch  2 taken 878724
branch  3 taken 722
    $$$$$:  185-block  2
branch  4 never executed
branch  5 never executed
  3537534:  186:                for (auto&& field : record)
      531:  186-block  0
     2123:  186-block  1
branch  0 taken 531
branch  1 taken 1592
     1592:  186-block  2
     1592:  186-block  3
   878794:  186-block  4
branch  2 taken 878759
branch  3 taken 35
   879111:  186-block  5
branch  4 taken 878935
branch  5 taken 176
   878935:  186-block  6
  3535622:  186-block  7
branch  6 taken 881335
branch  7 taken 2654287
  2656687:  186-block  8
  2656687:  186-block  9
    $$$$$:  186-block 10
    $$$$$:  186-block 11
branch  8 never executed
branch  9 never executed
    $$$$$:  186-block 12
    $$$$$:  186-block 13
        -:  187:                {
  2655879:  188:                    query += "$" + std::to_string(param_counter++) + ", ";
     1592:  188-block  0
branch  0 taken 1592
branch  1 taken 0
     1592:  188-block  1
branch  2 taken 0
branch  3 taken 1592
     1592:  188-block  2
branch  4 taken 0
branch  5 taken 1592
    $$$$$:  188-block  3
    $$$$$:  188-block  4
    $$$$$:  188-block  5
  2654287:  188-block  6
branch  6 taken 2654287
branch  7 taken 0
  2654287:  188-block  7
branch  8 taken 0
branch  9 taken 2654287
  2654287:  188-block  8
branch 10 taken 0
branch 11 taken 2654287
    $$$$$:  188-block  9
    $$$$$:  188-block 10
    $$$$$:  188-block 11
    $$$$$:  188-block 12
branch 12 never executed
branch 13 never executed
    $$$$$:  188-block 13
branch 14 never executed
branch 15 never executed
    $$$$$:  188-block 14
branch 16 never executed
branch 17 never executed
    $$$$$:  188-block 15
    $$$$$:  188-block 16
    $$$$$:  188-block 17
        -:  189:
        -:  190:                    // Call the correct version of to_string() depending on the value category
  2655879:  191:                    params.append(std::forward<decltype(field)>(field)->to_string());
     1592:  191-block  0
branch  0 taken 1592
branch  1 taken 0
     1592:  191-block  1
branch  2 taken 1592
branch  3 taken 0
    $$$$$:  191-block  2
  2659087:  191-block  3
branch  4 taken 2656687
branch  5 taken 2400
  2656687:  191-block  4
branch  6 taken 2656687
branch  7 taken 0
    $$$$$:  191-block  5
    $$$$$:  191-block  6
branch  8 never executed
branch  9 never executed
    $$$$$:  191-block  7
branch 10 never executed
branch 11 never executed
    $$$$$:  191-block  8
        -:  192:                }
   881866:  193:                query.erase(query.size() - 2); // Remove last comma and space
      531:  193-block  0
branch  0 taken 531
branch  1 taken 0
   881335:  193-block  1
branch  2 taken 879131
branch  3 taken 2204
    $$$$$:  193-block  2
branch  4 never executed
branch  5 never executed
   879662:  194:                query += "), ";
      531:  194-block  0
branch  0 taken 531
branch  1 taken 0
   879131:  194-block  1
branch  2 taken 878002
branch  3 taken 1129
    $$$$$:  194-block  2
branch  4 never executed
branch  5 never executed
        -:  195:            }
   100066:  196:            query.erase(query.size() - 2); // Remove last comma and space
       14:  196-block  0
branch  0 taken 14
branch  1 taken 0
   100052:  196-block  1
branch  2 taken 100052
branch  3 taken 0
    $$$$$:  196-block  2
branch  4 never executed
branch  5 never executed
   100066:  197:            query += ";";
       14:  197-block  0
branch  0 taken 14
branch  1 taken 0
   100052:  197-block  1
branch  2 taken 100052
branch  3 taken 0
    $$$$$:  197-block  2
branch  4 never executed
branch  5 never executed
   100066:  198:            return {query, params};
       14:  198-block  0
branch  0 taken 14
branch  1 taken 0
   100052:  198-block  1
branch  2 taken 93386
branch  3 taken 6666
    $$$$$:  198-block  2
branch  4 never executed
branch  5 never executed
   106732:  199:        }
    $$$$$:  199-block  0
    $$$$$:  199-block  1
    $$$$$:  199-block  2
    $$$$$:  199-block  3
    $$$$$:  199-block  4
    $$$$$:  199-block  5
    $$$$$:  199-block  6
    $$$$$:  199-block  7
       14:  199-block  8
    $$$$$:  199-block  9
    $$$$$:  199-block 10
    $$$$$:  199-block 11
    $$$$$:  199-block 12
    $$$$$:  199-block 13
    $$$$$:  199-block 14
    $$$$$:  199-block 15
    $$$$$:  199-block 16
    $$$$$:  199-block 17
    $$$$$:  199-block 18
    $$$$$:  199-block 19
    $$$$$:  199-block 20
    $$$$$:  199-block 21
    93386:  199-block 22
    $$$$$:  199-block 23
    $$$$$:  199-block 24
    $$$$$:  199-block 25
    $$$$$:  199-block 26
    $$$$$:  199-block 27
    $$$$$:  199-block 28
    $$$$$:  199-block 29
    $$$$$:  199-block 30
    $$$$$:  199-block 31
    $$$$$:  199-block 32
    $$$$$:  199-block 33
    $$$$$:  199-block 34
    $$$$$:  199-block 35
    $$$$$:  199-block 36
    $$$$$:  199-block 37
    $$$$$:  199-block 38
    $$$$$:  199-block 39
    $$$$$:  199-block 40
    $$$$$:  199-block 41
        -:  200:
        -:  201:        std::string escape_identifier(std::string_view identifier) const;
        -:  202:
        -:  203:        std::unique_ptr<pqxx::work> initialize_transaction() const;
        -:  204:        void finish_transaction(std::unique_ptr<pqxx::work>&& current_transaction) const;
        -:  205:        static exceptions::DatabaseException adapt_exception(const std::exception& pqxxerr);
        -:  206:
        -:  207:        void build_conflict_clause_for_force_insert(std::string& query, std::string_view table_name,
        -:  208:                                                    const std::vector<std::shared_ptr<FieldBase>>& replace_fields)
        -:  209:        const &;
        -:  210:        void conditions_to_query(std::string_view table_name, std::ostringstream& query_stream,
        -:  211:                                 pqxx::params& params,
        -:  212:                                 uint32_t& param_index, const Conditions& conditions) const;
        -:  213:
        -:  214:        void create_fts_index_query(std::string_view table_name, std::ostringstream& index_query) const;
        -:  215:        static std::string make_fts_index_name(std::string_view table_name);
        -:  216:    };
        -:  217:}
